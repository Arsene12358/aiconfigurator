apiVersion: batch/v1
kind: Job
metadata:
  name: {{ BenchConfig.name }}
  namespace: {{ K8sConfig.k8s_namespace | default("default") }}
spec:
  backoffLimit: 0
  template:
    metadata:
      name: {{ BenchConfig.name }}
    spec:
      restartPolicy: Never
      containers:
        - name: aiperf
          image: {{ BenchConfig.image }}
          env:
            - name: AIPERF_SERVICE_PROFILE_START_TIMEOUT
              value: "{{ BenchConfig.profile_start_timeout }}"
          command: ["/bin/bash", "-c"]
          args:
            - |
              pip install aiperf
              {% set base_concurrency = [1, 2, 8, 16, 32, 64, 128] %}
              {% if BenchConfig.estimated_concurrency and BenchConfig.estimated_concurrency > 0 %}
              {% set eff = BenchConfig.estimated_concurrency | int %}
              {% set eff_low = (BenchConfig.estimated_concurrency * 0.95) | int %}
              {% set eff_high = (BenchConfig.estimated_concurrency * 1.05) | int %}
              {% set combined = base_concurrency + [eff_low, eff, eff_high] %}
              {% set ns = namespace(seen=[]) %}
              {% for c in combined %}
              {% if c not in ns.seen %}
              {% set ns.seen = ns.seen + [c] %}
              {% endif %}
              {% endfor %}
              concurrency_array=({{ ns.seen | sort | join(' ') }})
              {% else %}
              concurrency_array=({{ base_concurrency | join(' ') }})
              {% endif %}
              ARTIFACT_DIR="${BENCH_ARTIFACT_DIR:-/tmp/bench_artifacts}"
              for concurrency in "${concurrency_array[@]}"; do
                echo "Run concurrency: $concurrency"
                aiperf profile \
                  --artifact-dir "${ARTIFACT_DIR}" \
                  -m {{ BenchConfig.model }} \
                  --endpoint-type {{ BenchConfig.endpoint_type }} \
                  -u {{ BenchConfig.endpoint_url }} \
                  --tokenizer {{ BenchConfig.tokenizer }} \
                  --isl {{ BenchConfig.isl }} --isl-stddev {{ BenchConfig.isl_stddev }} \
                  --osl {{ BenchConfig.osl }} --osl-stddev {{ BenchConfig.osl_stddev }} \
                  --extra-inputs ignore_eos:true \
                  --extra-inputs "{\"nvext\":{\"ignore_eos\":true}}" \
                  --concurrency ${concurrency} \
                  --num-requests $(($concurrency*50)) \
                  --warmup-request-count $(($concurrency*2)) \
                  --random-seed 100 \
                  --ui {{ BenchConfig.ui }} \
                  --streaming
              done
